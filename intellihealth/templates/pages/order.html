<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Appointment</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f7f7;
        }
        .container {
            max-width: 600px;
            margin: 50px auto;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        form {
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        select {
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        input[type="submit"] {
            padding: 10px 20px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        input[type="submit"]:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Order Prescription Medications</h1>
        <form id="appointmentForm" method="post">
            {% csrf_token %}

            <input type="hidden" name="id" value="{{patient_id}}">
            <input type="hidden" id="file" value="{{file_name}}">
            <input type="hidden" id="category" value="{{category}}">


            
            <label for="pharmacy">Select Pharmacy</label>
            <select id="pharmacySelect" name="pharmacy" required>
                <option value="">Select Pharmacy</option>
                {% for pharmacy in pharmacies %}
                    <option value="{{ pharmacy.id }}">{{ pharmacy.name }}</option>
                {% endfor %}
            </select>
    
            <label for="day">Select Day</label>
            <select id="daySelect" name="day" required disabled>
                <!-- Options for days will be dynamically populated here -->
                <option value="">Select Day</option>
                <option value="Monday">Monday</option>
                <option value="Tuesday">Tuesday</option>
                <option value="Wednesday">Wednesday</option>
                <option value="Thursday">Thursday</option>
                <option value="Friday">Friday</option>
                <option value="Saturday">Saturday</option>
                <option value="Sunday">Sunday</option>
            </select>
    
            <label for="date">Select Date</label>
            <select id="dateSelect" name="date" required disabled>
                <option value="">Select Date</option>
            </select>
    
            <label for="time">Select Time</label>
            <select id="timeSelect" name="time" required disabled>
                <option value="">Select Time</option>
            </select>

            
    
            <input type="submit" value="Order" id="submitBtn">
        </form>
    </div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    
    $(document).ready(function() {
    $('#pharmacySelect').change(function() {
        $('#daySelect').prop('disabled', false);
    });

    $('#daySelect').change(function() {
        $('#dateSelect').prop('disabled', false);
        populateDates();
    });

    $('#dateSelect').change(function() {
        $('#timeSelect').prop('disabled', false);
    });

    $('#submitBtn').click(function(event) {
        console.log('Button clicked');
        event.preventDefault();

        var pharmacy = $('#pharmacySelect').val();
        var day = $('#daySelect').val();
        var date = $('#dateSelect').val();
        var time = $('#timeSelect').val();
        var patient_id = $('id').val();
        var file = $('#file').val();
        var category = $('#category').val();
        
        // Send AJAX request to create a new appointment
        $.ajax({
            url: '/make_order/',
            type: 'POST',
            headers: {
                'X-CSRFToken': $('[name="csrfmiddlewaretoken"]').val()
            },
            data: {
                'pharmacy': pharmacy,
                'day': day, 
                'date': date,
                'time': time,
                'file': file,
                'category': category
            },
            success: function(response) {
        // Check if the response contains an error
        if (response.error) {
            // Handle the error
            alert('Error: ' + response.error);
        } else {
            // Handle success response
            alert('Order Sent successfully!');
            window.history.back();
        }
    },
    error: function(xhr, status, error) {
        // Handle error response
        alert('Error: ' + error);
        console.error('Error:', error);
    }
        });
    });
});

function populateDates() {
    // Clear existing options
    document.getElementById("dateSelect").innerHTML = "<option value=''>Select Date</option>";
    
    // Get the selected day from the dropdown
    var selectedDay = document.getElementById("daySelect").value;
    
    // Create an array to map day names to their corresponding day of the week
    var dayMap = {
        "Sunday": 0,
        "Monday": 1,
        "Tuesday": 2,
        "Wednesday": 3,
        "Thursday": 4,
        "Friday": 5,
        "Saturday": 6
    };

    // Get the current month and year
    var currentDate = new Date();
    var currentMonth = currentDate.getMonth();
    var currentYear = currentDate.getFullYear();
    
    // Loop through all days of the current month
    for (var date = 1; date <= 31; date++) {
        var tempDate = new Date(currentYear, currentMonth, date);
        var dayOfWeek = tempDate.getDay(); // 0 (Sunday) to 6 (Saturday)
        
        // If the day of the week matches the selected day, add it as an option
        if (dayOfWeek === dayMap[selectedDay]) {
            var option = document.createElement("option");
            option.text = tempDate.toDateString();
            var dateString = currentYear + '-' + ('0' + (currentMonth + 1)).slice(-2) + '-' + ('0' + date).slice(-2);

            option.value = dateString;
            //option.value = tempDate.toISOString().split('T')[0]; // Format: YYYY-MM-DD
            document.getElementById("dateSelect").appendChild(option);
        }
    }
}

$(document).ready(function() {
        $('#dateSelect').change(function() {
            var selectedDate = $(this).val();

            $.ajax({
                url: '/get_order_available_times/',
                type: 'GET',
                data: {
                    date: selectedDate
                },
                success: function(response) {
                    // Populate the time select dropdown with the available times
                    var times = response.times;
                    $('#timeSelect').empty().append('<option value="">Select Time</option>');
                    for (var i = 0; i < times.length; i++) {
                        $('#timeSelect').append($('<option>', {
                            value: times[i],
                            text: times[i]
                        }));
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                }
            });
        });
    });


// Call populateDates() initially to populate dates for the default day
//populateDates();
populateTimes();



</script>


</body>
</html>
